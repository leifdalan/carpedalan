version: '2.4'

services:
  alb:
    extends:
      file: docker-compose.base.yml
      service: alb
      
      
    depends_on:
      api: 
        condition: service_healthy
      client: 
        condition: service_healthy
    ports:
      - 443:443
    volumes:
      - ./public:/public/:cached
      - ./client/dist:/assets/:cached


  api:
    extends:
      file: docker-compose.base.yml
      service: api

    ports:
      - 9227:9229
    volumes:
      - './server:/app/server:cached'
      - './client/dist:/app/server/dist:cached'
      - './client/src/swaggerSchema.d.ts:/app/swaggerSchema.d.ts:cached'
      - './client/src/ApiClient.ts:/app/ApiClient.ts:cached'
      - './scripts:/app/scripts:cached'
      - './index.js:/app/index.js:cached'
      - './db:/app/db:cached'
      - './shared:/app/shared:cached'
      - './.env-local:/app/.env:cached'
      - './dev-dump.sql:/app/dev-dump.sql:cached'

    environment: 
      DEFAULT_POSTS_PER_PAGE: "${DEFAULT_POSTS_PER_PAGE-100}"

    depends_on:
      pg:
        condition: service_healthy
    env_file: 
      - .env-local


  client: 
    extends:
      file: docker-compose.base.yml
      service: client
    ports:
      - 4000:4000
    environment: 
      DEFAULT_POSTS_PER_PAGE: "${DEFAULT_POSTS_PER_PAGE-100}"



  pg:
    extends:
      file: docker-compose.base.yml
      service: pg
    ports: 
      - 5432:5432
    # This will auto-import this sql dump on init
    # volumes: 
      # - ./dev-dump.sql:/docker-entrypoint-initdb.d/dev-dump.sql:cached

  sam:
    extends:
      file: docker-compose.base.yml
      service: sam
    environment: 
      DEBUG_SAM: "${DEBUG_SAM-}"
      COMPOSE_PROJECT_NAME: ${COMPOSE_PROJECT_NAME-cd}
    ports:
      - "3001:3001"
      

  aws:
    extends:
      file: docker-compose.base.yml
      service: aws
    # ports:
    #   - "4567-4595:4567-4595"
    #   - "${PORT_WEB_UI-8081}:${PORT_WEB_UI-8081}"    

  redis:
    extends:
      file: docker-compose.base.yml
      service: redis
    ports: 
      - 6379:6379
    # Mounting this and running the below command will import this
    volumes: 
      - ./output.rdb:/data/dir/output.rdb:cached
    
    command: redis-server --dbfilename output.rdb --dir /data/dir/




  
